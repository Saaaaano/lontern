doctype html 
html(lang="ja")
    head 
        meta(charset="utf-8")
        title lontern 
        link(rel="stylesheet" href="/css/stylesheet.css")
    body 
        if character == null 
            - character = {}

        //- 記事数のカウント
        - var dispNum = {}
        - var all = 0
        - var nomal = 0
        - var secret = 0
        - var solo = 0
        - var anonymous = 0
        - var audience = 0
        each comment in comments
            case comment.section
                when "nomal"
                    if comment.permission == "audience"
                        - audience++
                        - comment.articleNum = audience 
                        if character.permission == "audience" || room.status == "終了" || room.ownerId == you
                            - all++
                            - comment.articleNumAll = all
                    else
                        - nomal++
                        - comment.articleNum = nomal 
                        - all++
                        - comment.articleNumAll = all
                when "secret"
                    - secret++
                    - comment.articleNum = secret 
                    if comment.send_to == character.character_name || comment.memberId == character.memberId || room.status == "終了"|| room.ownerId == you
                        - all++
                        - comment.articleNumAll = all
                when "solo"
                    - solo++
                    - comment.articleNum = solo 
                    if comment.character_name == character.character_name || room.status == "終了"|| room.ownerId == you
                        - all++
                        - comment.articleNumAll = all
                when "anonymous"
                    - anonymous++
                    - comment.articleNum = anonymous
                    - all++
                    - comment.articleNumAll = all
                when "action"
                    - all++
                    - comment.articleNumAll = all

        //- ページ送りリンクをつける関数
        - var allPageNum = Math.ceil(all / 20)
        mixin pageset()
            - for(var p = 1; p <= allPageNum; p++)
                if p == pageNum
                    a #{p}｜
                    - continue
                a(href="/session/" + room.name + "/" + p) #{p}
                a ｜

        div(class="session_main")
        
            div(class="header") 
                div(class="pagetitle") #{room.name}
                div(class="topbtn")
                    a(href="/index") 
                        img(src="/images/lontern_logo_w.png" width="100px")

            div(class="page")
                +pageset()

           
            - console.log(all)
            - console.log(comments.length)
            if pageNum != 1
                - dispNum.bigin = pageNum * 20 - 19
                - dispNum.final = pageNum * 20
            else
                - dispNum.bigin = Number(pageNum)
                - dispNum.final = pageNum * 20
            - console.log(dispNum)
            
            each comment in comments
                if comment.articleNumAll < dispNum.bigin
                    - continue
                else if comment.articleNumAll > dispNum.final
                    - continue

                //- 終了後はすべてオープンする
                if room.status != "終了" && room.ownerId != you
                    - console.log("通らないはず")
                    case comment.section
                        when "secret"
                            if comment.send_to != character.character_name && comment.memberId != character.memberId 
                                - continue
                        when "solo"
                            if comment.character_name != character.character_name 
                                - continue 
                    if comment.permission == "audience"
                        if character.permission != "audience"
                            - continue

                if comment.section == "action"
                    div(class="action") #{comment.comment} 
                    - continue 
                    
                div(class="preview")
                    a 
                        if comment.section == "anonymous"
                            img(src="/images/anonymous.png" width="110" height="110")
                        else 
                            img(src="/images/upload_icon/" + comment.image width="110" height="110")
                    div(class="speech_data" id="speechData")
                        - var audienceTag = ""
                        if comment.permission == "audience"
                            - audienceTag = "(観戦)"
                        case comment.section
                            when "solo"
                                a(id="-"+solo) -#{comment.articleNum}. #{comment.character_name} #{audienceTag}
                            when "nomal"
                                if audienceTag
                                    a(id="!"+audience) !#{comment.articleNum}. #{comment.character_name} #{audienceTag} 
                                else 
                                    a(id=nomal) #{comment.articleNum}. #{comment.character_name} 
                            when "secret"
                                a(id="@"+secret) @#{comment.articleNum}. #{comment.character_name} #{audienceTag} → #{comment.send_to} 
                            when "anonymous"
                                a(id="?"+anonymous) ?#{comment.articleNum}. #{audienceTag}

                        a(class="date") #{comment.comment_at}
                        div
                            - var balloon = ""
                            if comment.section == "nomal" && comment.permission == "audience"
                                - balloon = "audience"
                            else 
                                - balloon = comment.section
                            case comment.comment_vol
                                when "big"
                                    div(class="speech_" + balloon)
                                        big 
                                            strong #{comment.comment} 
                                when "small"
                                    div(class="speech_" + balloon)
                                        small 
                                            font(color="gray") #{comment.comment} 
                                when "nomal"
                                    div(class="speech_" + balloon) #{comment.comment} 

            div(class="page")
                +pageset()

            if character.character_name 
                div(class="say_space")
                    img(src="/images/upload_icon/" + character.image width="110" height="110")
                    div(class="say_box")
                        form(action="/say/" + character.sessionname + "/" + pageNum method="post")
                            a(class="name")
                                big 
                                    strong #{character.character_name} 
                            if character.permission == "audience"
                                a
                                    big 
                                        strong (観戦)
                            p(class="sayselect")
                                label
                                    a 発言種別: 
                                    select(name="say")
                                        option(value="nomal") セリフ
                                        option(value="secret") 秘匿
                                        option(value="anonymous") 匿名
                                        option(value="action") アクション
                                        option(value="solo") 独り言
                                label
                                    a(class="to_sel") To:
                                    select(name="to")
                                        option(value="GM") #{room.Owner}(GM)
                                        each member in members 
                                            if member.permission == character.permission
                                                option(value=member.character_name) #{member.character_name}
                            p
                                textarea(name="comment" rows="10" cols="80" required)
                            p 
                                label
                                    input(name="vol_size" value="nomal" type="radio" checked="checked") 
                                    a 通常 
                                label
                                    input(name="vol_size" value="big" type="radio")
                                    a 大声 
                                label
                                    input(name="vol_size" value="small" type="radio") 
                                    a 小声 
                            p(class="say_btn")
                                input(class="say_submit" type="submit" value="発言")
                    
